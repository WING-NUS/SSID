<h2>Users</h2>
<% if flash[:notice] %>
  <div class="notice">
    <%= flash[:notice] %>
  </div>
<% end %>
<% if flash[:alert] %>
  <div class="alert">
    <%= flash[:alert] %>
  </div>
<% end %>

<div class="admin_users_section"> 
<header class="user_header">
<h3>Admins</h3>
<%= link_to image_tag("person_add_black_24dp.svg", size: "28", alt: "New Admin"), new_admin_user_url, {'data-toggle' => 'tooltip', 'data-placement' => 'bottom', 'title' => 'New Admin'} %>
</header>

<table>
  <thead>
    <tr>
      <th>Full Name</th>
      <th class="id_col">Login</th>
      <th class="actions_col">Actions</th>
    </tr>
  </thead>
  <tbody>
    <% @admins.each { |admin| %>
      <tr>
        <td><%= admin.full_name || "--" %><%= " <em>(This is you)</em>".html_safe if @user == admin %></td>
        <td><%= admin.name %></td>
        <td>
          <div class="dropdown">
            <a data-toggle="dropdown" id="adminUserDropdownMenuLink" data-bs-toggle="dropdown" aria-expanded="false">
              <%= image_tag("more_vert_black_24dp.svg", alt: "Admin User Menu Dropdown")%>            
            </a>
            <ul class="dropdown-menu" aria-labelledby="adminUserDropdownMenuLink">
              <% if admin == @user %>
                <li><%= link_to "Settings", edit_user_url(@user), class: "dropdown-item" %></li>
              <% else %>
                <li><%= link_to "Edit", edit_admin_user_url(admin), class: "dropdown-item" %></li>
                <li>
                  <%= button_tag 'Delete', class: "dropdown-item", data: { 'bs-toggle' => "modal", 'bs-target' => "#deleteUserModal", 'bs-url' => "#{admin_user_url(admin)}" } %>
                </li>
              <% end %>
            </ul>
          </div>
        </td>
      </tr>
    <% } %>
  </tbody>
</table>

</div>

<% @courses.each { |course| %>
<div class="course_users_section">
  <header>
    <h3><%= course.code %> <%= course.name %></h3>
    <%= link_to image_tag("person_add_black_24dp.svg", size: "28", alt: "Add #{course.code} User"), new_admin_user_url+"?course_id=#{course.id}", { 'data-toggle' => 'tooltip', 'data-placement' => 'bottom', 'title' => "Add #{course.code} User" } %>
  </header>

  <% unless (@staff[course.id] + @teaching_assistants[course.id] + @students[course.id] + @guests[course.id]).empty? %>
  <table>
    <thead>
      <tr>
        <th>Full Name</th>
        <th class="id_col">Login</th>
        <th class="id_col">ID/ Hash</th>
        <th class="role_col">Role</th>
        <th class="actions_col">Actions</th>
      </tr>
    </thead>
    <tbody>
      <% (@staff[course.id] + @teaching_assistants[course.id] + @students[course.id] + @guests[course.id]).each { |user| %>
        <tr>
          <td> 
            <% if course.membership_for_user(user).role == UserCourseMembership::ROLE_GUEST %> 
              <%= "--" %> 
            <% else %> 
              <%= user.full_name || "--" %>
            <% end %>
          </td>
          <td>
            <% if course.membership_for_user(user).role == UserCourseMembership::ROLE_GUEST %> 
              <%= "--" %> 
            <% else %> 
              <%= user.name || "--" %>
            <% end %>
          </td>
          <td><%= user.id_string %></td>
          <td><%= course.role_string_for_user(user) %></td>
          <td>
            <div class="dropdown">
              <a data-toggle="dropdown" id="userDropdownMenuLink" data-bs-toggle="dropdown" aria-expanded="false">
                <%= image_tag("more_vert_black_24dp.svg", alt: "User Menu Dropdown")%>        
              </a>
              <ul class="dropdown-menu" aria-labelledby="userDropdownMenuLink">
                <li><%= link_to "Edit", edit_admin_user_url(user)+"?course_id=#{course.id}", class: "dropdown-item" %></li>
                <% if course.membership_for_user(user).role != UserCourseMembership::ROLE_STUDENT %>
                  <li><%= link_to "Remove", admin_user_url(user)+"?course_id=#{course.id}", method: "delete", data: {confirm: "Do you want to confirm remove user from course?"}, class: "dropdown-item" %></li>
                <li>
                  <% url = admin_user_url(user)+"?course_id=#{course.id}" %>
                  <%= button_tag 'Remove', class: "dropdown-item", data: { 'bs-toggle' => "modal", 'bs-target' => "#removeUserModal", 'bs-url' => "#{url}" } %>
                </li>                
                <% end %>
              </ul>
            </div>
          </td>
        </tr>
      <% } %>
    </tbody>
  </table>
  <% end %>


</div>
<% } %>

<% unless @loners.empty? %>
<div class="lone_users_section">

  <h3>Users With No Course Membership</h3>

  <table>
    <thead>
      <tr>
        <th>Full Name/ Hash</th>
        <th class="id_col">Login/ Hash</th>
        <th class="id_col">ID/ Hash</th>
        <th class="actions_col">Actions</th>
      </tr>
    </thead>
    <tbody>
      <% @loners.each { |user| %>
        <tr>
          <td><%= user.full_name || "--" %></td>
          <td><%= user.name %></td>
          <td><%= user.id_string %></td>
          <td>
            <div class="dropdown">
              <a data-toggle="dropdown" id="loneUserDropdownMenuLink" data-bs-toggle="dropdown" aria-expanded="false">
                <%= image_tag("more_vert_black_24dp.svg", alt: "Lone Users Menu Dropdown")%>        
              </a>
              <ul class="dropdown-menu" aria-labelledby="loneUserDropdownMenuLink">
                <li><%= link_to "Edit", edit_admin_user_url(user), class: 'dropdown-item' %></li>
                <li>
                  <%= button_tag 'Delete', class: "dropdown-item", data: { 'bs-toggle' => "modal", 'bs-target' => "#deleteUserModal", 'bs-url' => "#{admin_user_url(user)}" } %>
                </li>
              </ul>
            </div>
          </td>          
        </tr>
      <% } %>
    </tbody>
  </table>
</div>
<% end %>

<div class="modal fade" id="deleteUserModal" tabindex="-1" role="dialog" aria-hidden="true">
  <% @modal = SiteModal.new("Delete User?", "The user will be permanently deleted. Are you sure?", { :name => "OK", :method => :delete }) %>
  <%= render partial: "site/modal", locals: { modal: @modal }%>
</div>

<div class="modal fade" id="removeUserModal" tabindex="-1" role="dialog" aria-hidden="true">
  <% @modal = SiteModal.new("Remove User?", "The user will be removed from the course. Are you sure?", { :name => "OK", :method => :delete }) %>
  <%= render partial: "site/modal", locals: { modal: @modal }%>
</div>

<%= javascript_include_tag "site_modal.js" %>